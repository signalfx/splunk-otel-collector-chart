name: Check for new chart dependency updates

# Description:
# This workflow automates the process of checking for and updating Helm chart dependencies.
# Specifically, it:
#   1. Checks for new versions of (subchart) dependencies listed in chart.yaml.
#   2. Updates chart.yaml with new versions where applicable.
#   3. If the 'opentelemetry-operator' subchart is updated in chart.yaml, it also updates related
#      image tags in values.yaml.

on:
  schedule:
    # Run every Monday at noon.
    - cron: "0 12 * * 1"
  workflow_dispatch:
    inputs:
      DEBUG_MODE:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  check_and_update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Continue all jobs even if one fails
      matrix:
        # Chart dependencies to check for version updates
        include:
          - name: 'operator'
            component: 'operator'
            yaml_file_path: 'helm-charts/splunk-otel-collector/Chart.yaml'
            dependency_name: 'opentelemetry-operator'
    env:
      DEBUG_MODE: ${{ github.event.inputs.DEBUG_MODE }}
    steps:
      - uses: actions/checkout@v6

      - name: Check for Version Updates
        id: check_for_update
        run: |
          echo "Checking chart dependency version for ${{ matrix.name }}"

          make update-chart-dep CHART_PATH=${{ matrix.yaml_file_path }} SUBCHART_NAME='${{ matrix.dependency_name }}' DEBUG_MODE=$DEBUG_MODE

      - name: Check for Operator CRD Updates
        id: check_for_crd_update
        if: ${{ matrix.name == 'operator' }}
        run: |
          make update-operator-crds DEBUG_MODE=$DEBUG_MODE

      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Open PR for Version Update
        id: open_pr
        if: ${{ steps.check_for_update.outputs.NEED_UPDATE == 1 || steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Update {0} chart dependency version and operator CRDs', matrix.name) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Update {0} chart dependency version', matrix.name)) || 'Update operator CRDs' }}
          title: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Bump {0} from {1} to {2} and update operator CRDs', matrix.name, steps.check_for_update.outputs.CURRENT_VER, steps.check_for_update.outputs.LATEST_VER) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Bump {0} from {1} to {2} in {3}', matrix.name, steps.check_for_update.outputs.CURRENT_VER, steps.check_for_update.outputs.LATEST_VER, matrix.yaml_file_path)) || format('Bump opentelemetry-operator-crds to {0}', steps.check_for_crd_update.outputs.CRDS_LATEST_VERSION) }}
          body: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Use the latest version of {0} and update operator CRDs', matrix.name) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Use the latest version of {0}', matrix.name)) || 'Update operator CRDs' }}
          branch: "update-${{ matrix.name }}"
          base: main
          delete-branch: true
          modify-outputs: false
          author: ${{ github.event_name == 'schedule' && 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>' || format('{0} <{1}+{0}@users.noreply.github.com>', github.actor, github.actor_id) }}


      - name: Apply Version Update and Generate Changelog
        if: ${{ steps.check_for_update.outputs.NEED_UPDATE == 1 }}
        run: |
          # Apply the version update, update the rendered examples with the version update, and create a changelog entry
          # We run `make update-chart-dep` again here because the open_pr peter-evans/create-pull-request step before clears out the update changes locally
          make update-chart-dep CHART_PATH=${{ matrix.yaml_file_path }} SUBCHART_NAME='${{ matrix.dependency_name }}' DEBUG_MODE=$DEBUG_MODE
          make render
          make chlog-new FILENAME="update-${{ matrix.name }}" CHANGE_TYPE=enhancement COMPONENT=${{ matrix.component }} NOTE="Bump ${{ matrix.name }} to ${{ steps.check_for_update.outputs.LATEST_VER }} in ${{ matrix.yaml_file_path }}" ISSUES=[${{ steps.open_pr.outputs.pull-request-number }}]

      - name: Operator CRDs update
        env:
          COMPONENT: opentelemetry-operator-crds
        if: ${{ steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        run: |
          make update-operator-crds DEBUG_MODE=$DEBUG_MODE
          make render
          make chlog-new FILENAME="update-operator-crds" CHANGE_TYPE=enhancement COMPONENT=$COMPONENT NOTE="Bump subchart $COMPONENT to ${{ steps.check_for_crd_update.outputs.CRDS_LATEST_VERSION }}. Refer to further [instructions](https://github.com/signalfx/splunk-otel-collector-chart/blob/main/helm-charts/splunk-otel-collector/charts/opentelemetry-operator-crds/README.md#upgrade-notes) for updating CRDs if using `operatorcrds.install` option." ISSUES=[${{ steps.open_pr.outputs.pull-request-number }}]

      - name: Set up Python
        if: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && matrix.name == 'operator') || steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Generate CRD Schemas for kubeconform
        # Regenerate schemas when operator chart or operator-crds are updated
        if: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && matrix.name == 'operator') || steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        run: |
          make generate-crd-schemas

      - name: Run pre-commit to fix formatting
        if: ${{ steps.check_for_update.outputs.NEED_UPDATE == 1 || steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        uses: ./.github/actions/run-precommit

      - name: Finalize PR with updates
        if: ${{ steps.check_for_update.outputs.NEED_UPDATE == 1 || steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1 }}
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Update {0} chart dependency version and operator CRDs', matrix.name) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Update {0} chart dependency version', matrix.name)) || 'Update operator CRDs and regenerate schemas' }}
          title: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Bump {0} from {1} to {2} and update operator CRDs', matrix.name, steps.check_for_update.outputs.CURRENT_VER, steps.check_for_update.outputs.LATEST_VER) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Bump {0} from {1} to {2} in {3}', matrix.name, steps.check_for_update.outputs.CURRENT_VER, steps.check_for_update.outputs.LATEST_VER, matrix.yaml_file_path)) || format('Bump opentelemetry-operator-crds to {0}', steps.check_for_crd_update.outputs.CRDS_LATEST_VERSION) }}
          body: ${{ (steps.check_for_update.outputs.NEED_UPDATE == 1 && steps.check_for_crd_update.outputs.CRDS_NEED_UPDATE == 1) && format('Use the latest version of {0} and update operator CRDs to {1} with schema regeneration', matrix.name, steps.check_for_crd_update.outputs.CRDS_LATEST_VERSION) || (steps.check_for_update.outputs.NEED_UPDATE == 1 && format('Use the latest version of {0}', matrix.name)) || format('Update operator CRDs to {0} and regenerate schemas for kubeconform validation', steps.check_for_crd_update.outputs.CRDS_LATEST_VERSION) }}
          branch: "update-${{ matrix.name }}"
          base: main
          delete-branch: true
          modify-outputs: false
          author: ${{ github.event_name == 'schedule' && 'github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>' || format('{0} <{1}+{0}@users.noreply.github.com>', github.actor, github.actor_id) }}
